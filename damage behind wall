local ref = gui.Tab(gui.Reference("Ragebot"), "behindwall", "Damage Behind Wall")
local save_fps = gui.Checkbox(ref, "savefps", "Savefps", false)
local box_auto = gui.Groupbox(ref, "Autosniper")
local box_sniper = gui.Groupbox(ref, "Sniper")
local box_scout = gui.Groupbox(ref, "Scaut")
local box_revolver = gui.Groupbox(ref, "Heavy Pistol")
local box_pistol = gui.Groupbox(ref, "Pistol")
local box_rifle = gui.Groupbox(ref, "Rifle")
save_fps:SetDescription("Increased Performance but decreases detection")
local box = { box_auto, box_sniper, box_scout, box_revolver, box_pistol, box_rifle }
local weapon_list = { "asniper", "sniper", "scout", "hpistol", "pistol", "rifle" }
for i = 1, 6 do
    local rbot_autosniper_mindamage_active = gui.Checkbox(box[i], weapon_list[i] .. ".mindmg.active", "Damage Behind Wall", false)
    local rbot_autosniper_mindamage_2 = gui.Slider(box[i], weapon_list[i] .. ".mindmg.2", "Damage Visible", 0, 0, 100);
    local rbot_autosniper_mindamage_1 = gui.Slider(box[i], weapon_list[i] .. ".mindmg.1", "Damage behind Wall", 0, 0, 100);
end


local adaptive_weapons = {
    -- see line 219
    ["asniper.mindmg"] = { 11, 38 },
    ["sniper.mindmg"] = { 9 },
    ["scout.mindmg"] = { 40 },
    ["hpistol.mindmg"] = { 64,1 },
    ["pistol.mindmg"] = { 2, 3, 4, 30, 32, 36, 61, 63 },
    ["rifle.mindmg"] = { 7, 8, 10, 13, 16, 39, 60 },    
    ["false"] = {},
}

local function table_contains(table, item) -- see line 219
    for i = 1, #table do
        if table[i] == item then
            return true
        end
    end
    return false
end

local function find_key(value) -- see line 219
    for k, v in pairs(adaptive_weapons) do
        if table_contains(v, value) then
            return k
        end
    end
end

local pPlayer
local function entities_check() -- getting local player informazion and if your crouched
    local LocalPlayer = entities.GetLocalPlayer();
    if enemy ~= nil then
        Alive = enemy:IsAlive()
    end
    if LocalPlayer ~= nil then
        pPlayer = LocalPlayer:GetAbsOrigin()
        if (math.floor((entities.GetLocalPlayer():GetPropInt("m_fFlags") % 4) / 2) == 1) then
            z = 46
        else
            z = 64 -- adjust your z Value so it traces from the head an not feet
        end
        pPlayer.z = pPlayer.z + z
        return LocalPlayer
    end
end

local function is_vis()
    local is_vis = false
    local players = entities.FindByClass("CCSPlayer")
    local fps = 4
    if save_fps:GetValue() then
        fps = 0
    end
    for i, player in pairs(players) do
        if player:GetTeamNumber() ~= entities.GetLocalPlayer():GetTeamNumber() and player:IsPlayer() and entities_check() ~= nil and player:IsAlive() then
            for i = 0, 4 do
                for x = 0, fps do
                    local v = player:GetHitboxPosition(i)

                    if x == 0 then
                        v.x = v.x
                        v.y = v.y
                    elseif x == 1 then
                        v.x = v.x
                        v.y = v.y + 4
                    elseif x == 2 then
                        v.x = v.x
                        v.y = v.y - 4
                    elseif x == 3 then
                        v.x = v.x + 4
                        v.y = v.y
                    elseif x == 4 then
                        v.x = v.x - 4
                        v.y = v.y
                    end

                    local c = engine.TraceLine(pPlayer.x, pPlayer.y, pPlayer.z, v.x, v.y, v.z, 1)
                    if c == 0 then
                        is_vis = true
                        break
                    end
                end
            end
        end
    end
    return is_vis
end

local function set_damage()

    if entities_check() then
        local weapon = entities_check():GetWeaponID()
        local slider = find_key(weapon) --finding mindamage var
        if slider ~= nil then
            local slider_invis = ("rbot.behindwall." .. slider .. ".1") -- getting the var name of the check boxes/sliders
            local slider_vis = ("rbot.behindwall." .. slider .. ".2")
            local active = gui.GetValue(("rbot.behindwall." .. slider .. ".active"))
            if active then
                is_vis()
                if slider ~= false then -- makes sure only support weapon is selected
                    if is_vis() then
                        local damage = gui.GetValue(slider_vis) --setting damage
                        gui.SetValue("rbot.accuracy.weapon." .. slider, damage)
                    else
                        local damage = gui.GetValue(slider_invis)
                        gui.SetValue("rbot.accuracy.weapon." .. slider, damage)
                    end
                end
            end
        end
    end
end


callbacks.Register("Draw", "set_damage", set_damage);
